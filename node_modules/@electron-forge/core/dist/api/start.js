"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "StartOptions", {
    enumerable: true,
    get: function() {
        return _sharedTypes.StartOptions;
    }
});
exports.default = void 0;
var _childProcess = require("child_process");
var _coreUtils = require("@electron-forge/core-utils");
var _sharedTypes = require("@electron-forge/shared-types");
var _chalk = _interopRequireDefault(require("chalk"));
var _debug = _interopRequireDefault(require("debug"));
var _listr2 = require("listr2");
var _electronExecutable = _interopRequireDefault(require("../util/electron-executable"));
var _forgeConfig = _interopRequireDefault(require("../util/forge-config"));
var _hook = require("../util/hook");
var _readPackageJson = require("../util/read-package-json");
var _resolveDir = _interopRequireDefault(require("../util/resolve-dir"));
function _interopRequireDefault(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
const d = (0, _debug).default('electron-forge:start');
var _default = async ({ dir: providedDir = process.cwd() , appPath ='.' , interactive =false , enableLogging =false , args =[] , runAsNode =false , inspect =false , inspectBrk =false  })=>{
    const platform = process.env.npm_config_platform || process.platform;
    const arch = process.env.npm_config_arch || process.arch;
    const listrOptions = {
        concurrent: false,
        rendererOptions: {
            collapseErrors: false
        },
        rendererSilent: !interactive,
        rendererFallback: Boolean(process.env.DEBUG && process.env.DEBUG.includes('electron-forge'))
    };
    const runner = new _listr2.Listr([
        {
            title: 'Locating application',
            task: async (ctx)=>{
                const resolvedDir = await (0, _resolveDir).default(providedDir);
                if (!resolvedDir) {
                    throw new Error('Failed to locate startable Electron application');
                }
                ctx.dir = resolvedDir;
            }
        },
        {
            title: 'Loading configuration',
            task: async (ctx)=>{
                const { dir  } = ctx;
                ctx.forgeConfig = await (0, _forgeConfig).default(dir);
                ctx.packageJSON = await (0, _readPackageJson).readMutatedPackageJson(dir, ctx.forgeConfig);
                if (!ctx.packageJSON.version) {
                    throw new Error(`Please set your application's 'version' in '${dir}/package.json'.`);
                }
            }
        },
        {
            title: 'Preparing native dependencies',
            task: async ({ dir , forgeConfig , packageJSON  }, task)=>{
                await (0, _coreUtils).listrCompatibleRebuildHook(dir, await (0, _coreUtils).getElectronVersion(dir, packageJSON), platform, arch, forgeConfig.rebuildConfig, task);
            },
            options: {
                persistentOutput: true,
                bottomBar: Infinity,
                showTimer: true
            }
        },
        {
            title: `Running ${_chalk.default.yellow('generateAssets')} hook`,
            task: async ({ forgeConfig  }, task)=>{
                return task.newListr(await (0, _hook).getHookListrTasks(forgeConfig, 'generateAssets', platform, arch));
            }
        }, 
    ], listrOptions);
    await runner.run();
    const { dir: dir1 , forgeConfig: forgeConfig1 , packageJSON: packageJSON1  } = runner.ctx;
    let lastSpawned = null;
    const forgeSpawn = async ()=>{
        let electronExecPath = null;
        // If a plugin has taken over the start command let's stop here
        let spawnedPluginChild = await forgeConfig1.pluginInterface.overrideStartLogic({
            dir: dir1,
            appPath,
            interactive,
            enableLogging,
            args,
            runAsNode,
            inspect,
            inspectBrk
        });
        if (typeof spawnedPluginChild === 'object' && 'tasks' in spawnedPluginChild) {
            const innerRunner = new _listr2.Listr([], listrOptions);
            for (const task of spawnedPluginChild.tasks){
                innerRunner.add(task);
            }
            await innerRunner.run();
            spawnedPluginChild = spawnedPluginChild.result;
        }
        let prefixArgs = [];
        if (typeof spawnedPluginChild === 'string') {
            electronExecPath = spawnedPluginChild;
        } else if (Array.isArray(spawnedPluginChild)) {
            [electronExecPath, ...prefixArgs] = spawnedPluginChild;
        } else if (spawnedPluginChild) {
            await (0, _hook).runHook(forgeConfig1, 'postStart', spawnedPluginChild);
            return spawnedPluginChild;
        }
        if (!electronExecPath) {
            electronExecPath = await (0, _electronExecutable).default(dir1, packageJSON1);
        }
        d('Electron binary path:', electronExecPath);
        const spawnOpts = {
            cwd: dir1,
            stdio: 'inherit',
            env: {
                ...process.env,
                ...enableLogging ? {
                    ELECTRON_ENABLE_LOGGING: 'true',
                    ELECTRON_ENABLE_STACK_DUMPING: 'true'
                } : {}
            }
        };
        if (runAsNode) {
            spawnOpts.env.ELECTRON_RUN_AS_NODE = 'true';
        } else {
            delete spawnOpts.env.ELECTRON_RUN_AS_NODE;
        }
        if (inspect) {
            args = [
                '--inspect'
            ].concat(args);
        }
        if (inspectBrk) {
            args = [
                '--inspect-brk'
            ].concat(args);
        }
        const spawned = (0, _childProcess).spawn(electronExecPath, prefixArgs.concat([
            appPath
        ]).concat(args), spawnOpts);
        await (0, _hook).runHook(forgeConfig1, 'postStart', spawned);
        return spawned;
    };
    const forgeSpawnWrapper = async ()=>{
        const spawned = await forgeSpawn();
        // When the child app is closed we should stop listening for stdin
        if (spawned) {
            if (interactive && process.stdin.isPaused()) {
                process.stdin.resume();
            }
            spawned.on('exit', ()=>{
                if (spawned.restarted) {
                    return;
                }
                if (interactive && !process.stdin.isPaused()) {
                    process.stdin.pause();
                }
            });
        } else if (interactive && !process.stdin.isPaused()) {
            process.stdin.pause();
        }
        lastSpawned = spawned;
        return lastSpawned;
    };
    if (interactive) {
        process.stdin.on('data', async (data)=>{
            if (data.toString().trim() === 'rs' && lastSpawned) {
                console.info(_chalk.default.cyan('\nRestarting App\n'));
                lastSpawned.restarted = true;
                lastSpawned.kill('SIGTERM');
                lastSpawned.emit('restarted', await forgeSpawnWrapper());
            }
        });
        process.stdin.resume();
    }
    const spawned1 = await forgeSpawnWrapper();
    if (interactive) console.log('');
    return spawned1;
};
exports.default = _default;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvc3RhcnQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc3Bhd24sIFNwYXduT3B0aW9ucyB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuXG5pbXBvcnQgeyBnZXRFbGVjdHJvblZlcnNpb24sIGxpc3RyQ29tcGF0aWJsZVJlYnVpbGRIb29rIH0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL2NvcmUtdXRpbHMnO1xuaW1wb3J0IHsgRWxlY3Ryb25Qcm9jZXNzLCBGb3JnZUFyY2gsIEZvcmdlTGlzdHJUYXNrLCBGb3JnZVBsYXRmb3JtLCBSZXNvbHZlZEZvcmdlQ29uZmlnLCBTdGFydE9wdGlvbnMgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2Uvc2hhcmVkLXR5cGVzJztcbmltcG9ydCBjaGFsayBmcm9tICdjaGFsayc7XG5pbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IHsgTGlzdHIgfSBmcm9tICdsaXN0cjInO1xuXG5pbXBvcnQgbG9jYXRlRWxlY3Ryb25FeGVjdXRhYmxlIGZyb20gJy4uL3V0aWwvZWxlY3Ryb24tZXhlY3V0YWJsZSc7XG5pbXBvcnQgZ2V0Rm9yZ2VDb25maWcgZnJvbSAnLi4vdXRpbC9mb3JnZS1jb25maWcnO1xuaW1wb3J0IHsgZ2V0SG9va0xpc3RyVGFza3MsIHJ1bkhvb2sgfSBmcm9tICcuLi91dGlsL2hvb2snO1xuaW1wb3J0IHsgcmVhZE11dGF0ZWRQYWNrYWdlSnNvbiB9IGZyb20gJy4uL3V0aWwvcmVhZC1wYWNrYWdlLWpzb24nO1xuaW1wb3J0IHJlc29sdmVEaXIgZnJvbSAnLi4vdXRpbC9yZXNvbHZlLWRpcic7XG5cbmNvbnN0IGQgPSBkZWJ1ZygnZWxlY3Ryb24tZm9yZ2U6c3RhcnQnKTtcblxuZXhwb3J0IHsgU3RhcnRPcHRpb25zIH07XG5cbnR5cGUgU3RhcnRDb250ZXh0ID0ge1xuICBkaXI6IHN0cmluZztcbiAgZm9yZ2VDb25maWc6IFJlc29sdmVkRm9yZ2VDb25maWc7XG4gIHBhY2thZ2VKU09OOiBhbnk7XG4gIHNwYXduZWQ6IEVsZWN0cm9uUHJvY2Vzcztcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jICh7XG4gIGRpcjogcHJvdmlkZWREaXIgPSBwcm9jZXNzLmN3ZCgpLFxuICBhcHBQYXRoID0gJy4nLFxuICBpbnRlcmFjdGl2ZSA9IGZhbHNlLFxuICBlbmFibGVMb2dnaW5nID0gZmFsc2UsXG4gIGFyZ3MgPSBbXSxcbiAgcnVuQXNOb2RlID0gZmFsc2UsXG4gIGluc3BlY3QgPSBmYWxzZSxcbiAgaW5zcGVjdEJyayA9IGZhbHNlLFxufTogU3RhcnRPcHRpb25zKTogUHJvbWlzZTxFbGVjdHJvblByb2Nlc3M+ID0+IHtcbiAgY29uc3QgcGxhdGZvcm0gPSBwcm9jZXNzLmVudi5ucG1fY29uZmlnX3BsYXRmb3JtIHx8IHByb2Nlc3MucGxhdGZvcm07XG4gIGNvbnN0IGFyY2ggPSBwcm9jZXNzLmVudi5ucG1fY29uZmlnX2FyY2ggfHwgcHJvY2Vzcy5hcmNoO1xuICBjb25zdCBsaXN0ck9wdGlvbnMgPSB7XG4gICAgY29uY3VycmVudDogZmFsc2UsXG4gICAgcmVuZGVyZXJPcHRpb25zOiB7XG4gICAgICBjb2xsYXBzZUVycm9yczogZmFsc2UsXG4gICAgfSxcbiAgICByZW5kZXJlclNpbGVudDogIWludGVyYWN0aXZlLFxuICAgIHJlbmRlcmVyRmFsbGJhY2s6IEJvb2xlYW4ocHJvY2Vzcy5lbnYuREVCVUcgJiYgcHJvY2Vzcy5lbnYuREVCVUcuaW5jbHVkZXMoJ2VsZWN0cm9uLWZvcmdlJykpLFxuICB9O1xuXG4gIGNvbnN0IHJ1bm5lciA9IG5ldyBMaXN0cjxTdGFydENvbnRleHQ+KFxuICAgIFtcbiAgICAgIHtcbiAgICAgICAgdGl0bGU6ICdMb2NhdGluZyBhcHBsaWNhdGlvbicsXG4gICAgICAgIHRhc2s6IGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgICBjb25zdCByZXNvbHZlZERpciA9IGF3YWl0IHJlc29sdmVEaXIocHJvdmlkZWREaXIpO1xuICAgICAgICAgIGlmICghcmVzb2x2ZWREaXIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGxvY2F0ZSBzdGFydGFibGUgRWxlY3Ryb24gYXBwbGljYXRpb24nKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY3R4LmRpciA9IHJlc29sdmVkRGlyO1xuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgdGl0bGU6ICdMb2FkaW5nIGNvbmZpZ3VyYXRpb24nLFxuICAgICAgICB0YXNrOiBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgICAgY29uc3QgeyBkaXIgfSA9IGN0eDtcbiAgICAgICAgICBjdHguZm9yZ2VDb25maWcgPSBhd2FpdCBnZXRGb3JnZUNvbmZpZyhkaXIpO1xuICAgICAgICAgIGN0eC5wYWNrYWdlSlNPTiA9IGF3YWl0IHJlYWRNdXRhdGVkUGFja2FnZUpzb24oZGlyLCBjdHguZm9yZ2VDb25maWcpO1xuXG4gICAgICAgICAgaWYgKCFjdHgucGFja2FnZUpTT04udmVyc2lvbikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBQbGVhc2Ugc2V0IHlvdXIgYXBwbGljYXRpb24ncyAndmVyc2lvbicgaW4gJyR7ZGlyfS9wYWNrYWdlLmpzb24nLmApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHRpdGxlOiAnUHJlcGFyaW5nIG5hdGl2ZSBkZXBlbmRlbmNpZXMnLFxuICAgICAgICB0YXNrOiBhc3luYyAoeyBkaXIsIGZvcmdlQ29uZmlnLCBwYWNrYWdlSlNPTiB9LCB0YXNrKSA9PiB7XG4gICAgICAgICAgYXdhaXQgbGlzdHJDb21wYXRpYmxlUmVidWlsZEhvb2soXG4gICAgICAgICAgICBkaXIsXG4gICAgICAgICAgICBhd2FpdCBnZXRFbGVjdHJvblZlcnNpb24oZGlyLCBwYWNrYWdlSlNPTiksXG4gICAgICAgICAgICBwbGF0Zm9ybSBhcyBGb3JnZVBsYXRmb3JtLFxuICAgICAgICAgICAgYXJjaCBhcyBGb3JnZUFyY2gsXG4gICAgICAgICAgICBmb3JnZUNvbmZpZy5yZWJ1aWxkQ29uZmlnLFxuICAgICAgICAgICAgdGFzayBhcyBGb3JnZUxpc3RyVGFzazxuZXZlcj5cbiAgICAgICAgICApO1xuICAgICAgICB9LFxuICAgICAgICBvcHRpb25zOiB7XG4gICAgICAgICAgcGVyc2lzdGVudE91dHB1dDogdHJ1ZSxcbiAgICAgICAgICBib3R0b21CYXI6IEluZmluaXR5LFxuICAgICAgICAgIHNob3dUaW1lcjogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHRpdGxlOiBgUnVubmluZyAke2NoYWxrLnllbGxvdygnZ2VuZXJhdGVBc3NldHMnKX0gaG9va2AsXG4gICAgICAgIHRhc2s6IGFzeW5jICh7IGZvcmdlQ29uZmlnIH0sIHRhc2spID0+IHtcbiAgICAgICAgICByZXR1cm4gdGFzay5uZXdMaXN0cihhd2FpdCBnZXRIb29rTGlzdHJUYXNrcyhmb3JnZUNvbmZpZywgJ2dlbmVyYXRlQXNzZXRzJywgcGxhdGZvcm0sIGFyY2gpKTtcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgXSxcbiAgICBsaXN0ck9wdGlvbnNcbiAgKTtcblxuICBhd2FpdCBydW5uZXIucnVuKCk7XG5cbiAgY29uc3QgeyBkaXIsIGZvcmdlQ29uZmlnLCBwYWNrYWdlSlNPTiB9ID0gcnVubmVyLmN0eDtcbiAgbGV0IGxhc3RTcGF3bmVkOiBFbGVjdHJvblByb2Nlc3MgfCBudWxsID0gbnVsbDtcblxuICBjb25zdCBmb3JnZVNwYXduID0gYXN5bmMgKCkgPT4ge1xuICAgIGxldCBlbGVjdHJvbkV4ZWNQYXRoOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcblxuICAgIC8vIElmIGEgcGx1Z2luIGhhcyB0YWtlbiBvdmVyIHRoZSBzdGFydCBjb21tYW5kIGxldCdzIHN0b3AgaGVyZVxuICAgIGxldCBzcGF3bmVkUGx1Z2luQ2hpbGQgPSBhd2FpdCBmb3JnZUNvbmZpZy5wbHVnaW5JbnRlcmZhY2Uub3ZlcnJpZGVTdGFydExvZ2ljKHtcbiAgICAgIGRpcixcbiAgICAgIGFwcFBhdGgsXG4gICAgICBpbnRlcmFjdGl2ZSxcbiAgICAgIGVuYWJsZUxvZ2dpbmcsXG4gICAgICBhcmdzLFxuICAgICAgcnVuQXNOb2RlLFxuICAgICAgaW5zcGVjdCxcbiAgICAgIGluc3BlY3RCcmssXG4gICAgfSk7XG4gICAgaWYgKHR5cGVvZiBzcGF3bmVkUGx1Z2luQ2hpbGQgPT09ICdvYmplY3QnICYmICd0YXNrcycgaW4gc3Bhd25lZFBsdWdpbkNoaWxkKSB7XG4gICAgICBjb25zdCBpbm5lclJ1bm5lciA9IG5ldyBMaXN0cjxuZXZlcj4oW10sIGxpc3RyT3B0aW9ucyk7XG4gICAgICBmb3IgKGNvbnN0IHRhc2sgb2Ygc3Bhd25lZFBsdWdpbkNoaWxkLnRhc2tzKSB7XG4gICAgICAgIGlubmVyUnVubmVyLmFkZCh0YXNrKTtcbiAgICAgIH1cbiAgICAgIGF3YWl0IGlubmVyUnVubmVyLnJ1bigpO1xuICAgICAgc3Bhd25lZFBsdWdpbkNoaWxkID0gc3Bhd25lZFBsdWdpbkNoaWxkLnJlc3VsdDtcbiAgICB9XG4gICAgbGV0IHByZWZpeEFyZ3M6IHN0cmluZ1tdID0gW107XG4gICAgaWYgKHR5cGVvZiBzcGF3bmVkUGx1Z2luQ2hpbGQgPT09ICdzdHJpbmcnKSB7XG4gICAgICBlbGVjdHJvbkV4ZWNQYXRoID0gc3Bhd25lZFBsdWdpbkNoaWxkO1xuICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShzcGF3bmVkUGx1Z2luQ2hpbGQpKSB7XG4gICAgICBbZWxlY3Ryb25FeGVjUGF0aCwgLi4ucHJlZml4QXJnc10gPSBzcGF3bmVkUGx1Z2luQ2hpbGQ7XG4gICAgfSBlbHNlIGlmIChzcGF3bmVkUGx1Z2luQ2hpbGQpIHtcbiAgICAgIGF3YWl0IHJ1bkhvb2soZm9yZ2VDb25maWcsICdwb3N0U3RhcnQnLCBzcGF3bmVkUGx1Z2luQ2hpbGQpO1xuICAgICAgcmV0dXJuIHNwYXduZWRQbHVnaW5DaGlsZDtcbiAgICB9XG5cbiAgICBpZiAoIWVsZWN0cm9uRXhlY1BhdGgpIHtcbiAgICAgIGVsZWN0cm9uRXhlY1BhdGggPSBhd2FpdCBsb2NhdGVFbGVjdHJvbkV4ZWN1dGFibGUoZGlyLCBwYWNrYWdlSlNPTik7XG4gICAgfVxuXG4gICAgZCgnRWxlY3Ryb24gYmluYXJ5IHBhdGg6JywgZWxlY3Ryb25FeGVjUGF0aCk7XG5cbiAgICBjb25zdCBzcGF3bk9wdHMgPSB7XG4gICAgICBjd2Q6IGRpcixcbiAgICAgIHN0ZGlvOiAnaW5oZXJpdCcsXG4gICAgICBlbnY6IHtcbiAgICAgICAgLi4ucHJvY2Vzcy5lbnYsXG4gICAgICAgIC4uLihlbmFibGVMb2dnaW5nXG4gICAgICAgICAgPyB7XG4gICAgICAgICAgICAgIEVMRUNUUk9OX0VOQUJMRV9MT0dHSU5HOiAndHJ1ZScsXG4gICAgICAgICAgICAgIEVMRUNUUk9OX0VOQUJMRV9TVEFDS19EVU1QSU5HOiAndHJ1ZScsXG4gICAgICAgICAgICB9XG4gICAgICAgICAgOiB7fSksXG4gICAgICB9IGFzIE5vZGVKUy5Qcm9jZXNzRW52LFxuICAgIH07XG5cbiAgICBpZiAocnVuQXNOb2RlKSB7XG4gICAgICBzcGF3bk9wdHMuZW52LkVMRUNUUk9OX1JVTl9BU19OT0RFID0gJ3RydWUnO1xuICAgIH0gZWxzZSB7XG4gICAgICBkZWxldGUgc3Bhd25PcHRzLmVudi5FTEVDVFJPTl9SVU5fQVNfTk9ERTtcbiAgICB9XG5cbiAgICBpZiAoaW5zcGVjdCkge1xuICAgICAgYXJncyA9IFsnLS1pbnNwZWN0JyBhcyBzdHJpbmcgfCBudW1iZXJdLmNvbmNhdChhcmdzKTtcbiAgICB9XG4gICAgaWYgKGluc3BlY3RCcmspIHtcbiAgICAgIGFyZ3MgPSBbJy0taW5zcGVjdC1icmsnIGFzIHN0cmluZyB8IG51bWJlcl0uY29uY2F0KGFyZ3MpO1xuICAgIH1cblxuICAgIGNvbnN0IHNwYXduZWQgPSBzcGF3bihcbiAgICAgIGVsZWN0cm9uRXhlY1BhdGghLCAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgIHByZWZpeEFyZ3MuY29uY2F0KFthcHBQYXRoXSkuY29uY2F0KGFyZ3MgYXMgc3RyaW5nW10pLFxuICAgICAgc3Bhd25PcHRzIGFzIFNwYXduT3B0aW9uc1xuICAgICkgYXMgRWxlY3Ryb25Qcm9jZXNzO1xuXG4gICAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ3Bvc3RTdGFydCcsIHNwYXduZWQpO1xuICAgIHJldHVybiBzcGF3bmVkO1xuICB9O1xuXG4gIGNvbnN0IGZvcmdlU3Bhd25XcmFwcGVyID0gYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHNwYXduZWQgPSBhd2FpdCBmb3JnZVNwYXduKCk7XG4gICAgLy8gV2hlbiB0aGUgY2hpbGQgYXBwIGlzIGNsb3NlZCB3ZSBzaG91bGQgc3RvcCBsaXN0ZW5pbmcgZm9yIHN0ZGluXG4gICAgaWYgKHNwYXduZWQpIHtcbiAgICAgIGlmIChpbnRlcmFjdGl2ZSAmJiBwcm9jZXNzLnN0ZGluLmlzUGF1c2VkKCkpIHtcbiAgICAgICAgcHJvY2Vzcy5zdGRpbi5yZXN1bWUoKTtcbiAgICAgIH1cbiAgICAgIHNwYXduZWQub24oJ2V4aXQnLCAoKSA9PiB7XG4gICAgICAgIGlmIChzcGF3bmVkLnJlc3RhcnRlZCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpbnRlcmFjdGl2ZSAmJiAhcHJvY2Vzcy5zdGRpbi5pc1BhdXNlZCgpKSB7XG4gICAgICAgICAgcHJvY2Vzcy5zdGRpbi5wYXVzZSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKGludGVyYWN0aXZlICYmICFwcm9jZXNzLnN0ZGluLmlzUGF1c2VkKCkpIHtcbiAgICAgIHByb2Nlc3Muc3RkaW4ucGF1c2UoKTtcbiAgICB9XG5cbiAgICBsYXN0U3Bhd25lZCA9IHNwYXduZWQ7XG4gICAgcmV0dXJuIGxhc3RTcGF3bmVkO1xuICB9O1xuXG4gIGlmIChpbnRlcmFjdGl2ZSkge1xuICAgIHByb2Nlc3Muc3RkaW4ub24oJ2RhdGEnLCBhc3luYyAoZGF0YSkgPT4ge1xuICAgICAgaWYgKGRhdGEudG9TdHJpbmcoKS50cmltKCkgPT09ICdycycgJiYgbGFzdFNwYXduZWQpIHtcbiAgICAgICAgY29uc29sZS5pbmZvKGNoYWxrLmN5YW4oJ1xcblJlc3RhcnRpbmcgQXBwXFxuJykpO1xuICAgICAgICBsYXN0U3Bhd25lZC5yZXN0YXJ0ZWQgPSB0cnVlO1xuICAgICAgICBsYXN0U3Bhd25lZC5raWxsKCdTSUdURVJNJyk7XG4gICAgICAgIGxhc3RTcGF3bmVkLmVtaXQoJ3Jlc3RhcnRlZCcsIGF3YWl0IGZvcmdlU3Bhd25XcmFwcGVyKCkpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHByb2Nlc3Muc3RkaW4ucmVzdW1lKCk7XG4gIH1cblxuICBjb25zdCBzcGF3bmVkID0gYXdhaXQgZm9yZ2VTcGF3bldyYXBwZXIoKTtcblxuICBpZiAoaW50ZXJhY3RpdmUpIGNvbnNvbGUubG9nKCcnKTtcblxuICByZXR1cm4gc3Bhd25lZDtcbn07XG4iXSwibmFtZXMiOlsiU3RhcnRPcHRpb25zIiwiZCIsImRlYnVnIiwiZGlyIiwicHJvdmlkZWREaXIiLCJwcm9jZXNzIiwiY3dkIiwiYXBwUGF0aCIsImludGVyYWN0aXZlIiwiZW5hYmxlTG9nZ2luZyIsImFyZ3MiLCJydW5Bc05vZGUiLCJpbnNwZWN0IiwiaW5zcGVjdEJyayIsInBsYXRmb3JtIiwiZW52IiwibnBtX2NvbmZpZ19wbGF0Zm9ybSIsImFyY2giLCJucG1fY29uZmlnX2FyY2giLCJsaXN0ck9wdGlvbnMiLCJjb25jdXJyZW50IiwicmVuZGVyZXJPcHRpb25zIiwiY29sbGFwc2VFcnJvcnMiLCJyZW5kZXJlclNpbGVudCIsInJlbmRlcmVyRmFsbGJhY2siLCJCb29sZWFuIiwiREVCVUciLCJpbmNsdWRlcyIsInJ1bm5lciIsIkxpc3RyIiwidGl0bGUiLCJ0YXNrIiwiY3R4IiwicmVzb2x2ZWREaXIiLCJyZXNvbHZlRGlyIiwiRXJyb3IiLCJmb3JnZUNvbmZpZyIsImdldEZvcmdlQ29uZmlnIiwicGFja2FnZUpTT04iLCJyZWFkTXV0YXRlZFBhY2thZ2VKc29uIiwidmVyc2lvbiIsImxpc3RyQ29tcGF0aWJsZVJlYnVpbGRIb29rIiwiZ2V0RWxlY3Ryb25WZXJzaW9uIiwicmVidWlsZENvbmZpZyIsIm9wdGlvbnMiLCJwZXJzaXN0ZW50T3V0cHV0IiwiYm90dG9tQmFyIiwiSW5maW5pdHkiLCJzaG93VGltZXIiLCJjaGFsayIsInllbGxvdyIsIm5ld0xpc3RyIiwiZ2V0SG9va0xpc3RyVGFza3MiLCJydW4iLCJsYXN0U3Bhd25lZCIsImZvcmdlU3Bhd24iLCJlbGVjdHJvbkV4ZWNQYXRoIiwic3Bhd25lZFBsdWdpbkNoaWxkIiwicGx1Z2luSW50ZXJmYWNlIiwib3ZlcnJpZGVTdGFydExvZ2ljIiwiaW5uZXJSdW5uZXIiLCJ0YXNrcyIsImFkZCIsInJlc3VsdCIsInByZWZpeEFyZ3MiLCJBcnJheSIsImlzQXJyYXkiLCJydW5Ib29rIiwibG9jYXRlRWxlY3Ryb25FeGVjdXRhYmxlIiwic3Bhd25PcHRzIiwic3RkaW8iLCJFTEVDVFJPTl9FTkFCTEVfTE9HR0lORyIsIkVMRUNUUk9OX0VOQUJMRV9TVEFDS19EVU1QSU5HIiwiRUxFQ1RST05fUlVOX0FTX05PREUiLCJjb25jYXQiLCJzcGF3bmVkIiwic3Bhd24iLCJmb3JnZVNwYXduV3JhcHBlciIsInN0ZGluIiwiaXNQYXVzZWQiLCJyZXN1bWUiLCJvbiIsInJlc3RhcnRlZCIsInBhdXNlIiwiZGF0YSIsInRvU3RyaW5nIiwidHJpbSIsImNvbnNvbGUiLCJpbmZvIiwiY3lhbiIsImtpbGwiLCJlbWl0IiwibG9nIl0sIm1hcHBpbmdzIjoiOzs7OytCQWdCU0EsQ0FBWTs7O2VBQVpBLFlBQVk7Ozs7QUFoQmUsR0FBZSxDQUFmLGFBQWU7QUFFWSxHQUE0QixDQUE1QixVQUE0QjtBQUNrQixHQUE4QixDQUE5QixZQUE4QjtBQUN6SCxHQUFPLENBQVAs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